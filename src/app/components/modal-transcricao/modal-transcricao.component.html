<!-- Modal de Transcri√ß√£o -->
<div class="modal-overlay" [class.modal-visible]="isVisible" (click)="fecharModal()">
  <div class="modal-content" [class.maximizado]="isMaximizado" (click)="$event.stopPropagation()">
    <!-- Header do Modal -->
    <div class="modal-header">
      <h2>Transcri√ß√£o da Audi√™ncia</h2>
      <div class="modal-controls">
        <button class="btn-maximizar" (click)="toggleMaximizar()" 
                [title]="isMaximizado ? 'Restaurar' : 'Maximizar'">
          <i [class]="isMaximizado ? 'fas fa-compress' : 'fas fa-expand'"></i>
        </button>
        <button class="btn-fechar" (click)="fecharModal()">&times;</button>
      </div>
    </div>

    <!-- Corpo do Modal -->
    <div class="modal-body">
      <!-- Barra de Progresso do √Åudio -->
      <div class="barra-progresso-container">
        <div class="info-tempo">
          <span>{{ formatarTempo(tempoAtualSegundos) }}</span>
          <span>{{ formatarTempo(tempoTotalSegundos) }}</span>
        </div>
        <div class="barra-progresso">
          <div class="progresso-preenchido" 
               [style.width.%]="(tempoAtualSegundos / tempoTotalSegundos) * 100"></div>
        </div>
      </div>

      <!-- Se√ß√£o de Busca -->
      <div class="secao-busca">
        <div class="campo-busca">
          <input 
            type="text" 
            [(ngModel)]="termoBusca" 
            placeholder="Buscar na transcri√ß√£o..."
            class="input-busca"
            (input)="buscarNaTranscricao()">
        </div>
      </div>

      <!-- Overlay para modo de edi√ß√£o de locutor -->
      <div class="edicao-locutor-overlay" 
           *ngIf="modoEdicaoLocutor" 
           (click)="cancelarEdicaoLocutor()"></div>

      <!-- Container Principal -->
      <div class="container-principal" 
           [class.modo-edicao-locutor]="modoEdicaoLocutor">
        
        <!-- √Årea dos Di√°logos -->
        <div class="area-dialogos">
          <div class="dialogo-item" 
               *ngFor="let dialogo of dialogosFiltrados; let i = index"
               [class.dialogo-marcado]="dialogo.marcado">
            
            <div class="dialogo-header">
              <div class="dialogo-identificacao">
                <button class="btn-trocar-locutor" 
                        (click)="iniciarTrocaLocutor(i)" 
                        [class.editavel]="!modoEdicaoLocutor">
                  <i class="fas fa-user-edit"></i>
                </button>
                <span class="dialogo-participante" 
                      [title]="'Clique para editar: ' + formatarIntervaloTempo(dialogo)"
                      (click)="abrirEdicaoLocutor(dialogo.participante)"
                      [class.editavel]="!modoEdicaoLocutor">{{ formatarNomeParticipante(dialogo.participante) }}:</span>
              </div>
              <div class="dialogo-acoes">
                <span class="dialogo-tempo">{{ dialogo.timestamp }}</span>
                <button class="btn-video-dialogo" 
                        (click)="abrirVideoEmJanela(dialogo)" 
                        title="Assistir v√≠deo desta fala">
                  <i class="fas fa-video"></i>
                </button>
                <button class="btn-editar" (click)="editarDialogo(i)" title="Editar participante"></button>
                <span class="dialogo-id">#{{ i + 1 }}</span>
              </div>
            </div>
            
            <div class="dialogo-conteudo">
              {{ dialogo.texto }}
            </div>
            
            <div class="dialogo-footer" *ngIf="dialogo.alteracoes?.length">
              <small class="texto-alteracoes">
                √öltima altera√ß√£o: {{ dialogo.alteracoes[dialogo.alteracoes.length - 1].data | date:'dd/MM/yyyy HH:mm' }}
                por {{ dialogo.alteracoes[dialogo.alteracoes.length - 1].usuario }}
              </small>
            </div>
          </div>
        </div>

        <!-- Painel Lateral -->
        <div class="painel-lateral" 
             [class.modo-edicao-locutor]="modoEdicaoLocutor">
          
          <!-- Modal Overlay para Edi√ß√£o de Locutor -->
          <div class="modal-overlay-locutor" *ngIf="modoEdicaoLocutor" (click)="cancelarEdicaoLocutor()">
            <div class="modal-janela-locutor" (click)="$event.stopPropagation()">
              <div class="modal-header-locutor">
                <h3>
                  <i class="fas fa-user-edit"></i>
                  Alterar Locutor
                </h3>
                <button class="btn-fechar" (click)="cancelarEdicaoLocutor()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              
              <div class="modal-body-locutor">
                <!-- Frase sendo editada -->
                <div class="frase-contexto" *ngIf="dialogoEditandoLocutor !== null">
                  <div class="header-frase">
                    <label>
                      <i class="fas fa-quote-left"></i>
                      Frase em edi√ß√£o:
                    </label>
                    <button class="btn-carregar-video" 
                            (click)="carregarVideoDialogo(dialogos[dialogoEditandoLocutor])"
                            [class.ativo]="videoCarregado"
                            title="Carregar v√≠deo desta frase para identificar o locutor">
                      <i class="fas fa-video" *ngIf="!videoCarregado"></i>
                      <i class="fas fa-eye" *ngIf="videoCarregado"></i>
                      {{ videoCarregado ? 'V√≠deo Carregado' : 'Carregar V√≠deo' }}
                    </button>
                  </div>
                  
                  <!-- Player de v√≠deo integrado -->
                  <div class="video-container" *ngIf="videoCarregado && dialogoVideoAtual">
                    <div class="video-info">
                      <span class="timestamp-video">‚è∞ {{ dialogoVideoAtual.timestamp }}</span>
                      <span class="participante-video">üë§ {{ formatarNomeParticipante(dialogoVideoAtual.participante) }}</span>
                    </div>
                    <video #videoPlayer 
                           controls 
                           [src]="videoUrl"
                           class="video-player"
                           (loadedmetadata)="onVideoLoaded()"
                           preload="metadata">
                      Seu navegador n√£o suporta v√≠deo HTML5.
                    </video>
                    <div class="video-controls">
                      <button class="btn-play-from-timestamp" 
                              (click)="playFromTimestamp()"
                              title="Reproduzir do momento exato da frase">
                        <i class="fas fa-play"></i>
                        Reproduzir do Momento
                      </button>
                      <button class="btn-close-video" 
                              (click)="fecharVideo()"
                              title="Fechar v√≠deo">
                        <i class="fas fa-times"></i>
                        Fechar
                      </button>
                    </div>
                  </div>
                  
                  <div class="texto-fala">
                    "{{ dialogos[dialogoEditandoLocutor].texto }}"
                  </div>
                </div>
                
                <!-- TROCAR LOCUTOR DA FRASE -->
                <div class="secao-trocar-locutor">
                  <h4 class="titulo-secao">
                    <i class="fas fa-user-edit"></i>
                    Selecionar Locutor
                  </h4>
                  
                  <div class="info-alteracao" *ngIf="novoLocutor.trim()">
                    <div class="locutor-de">
                      <label>De:</label>
                      <span class="nome-de">{{ formatarNomeParticipante(locutorOriginal) }}</span>
                    </div>
                    <div class="seta-alteracao">
                      <i class="fas fa-arrow-right"></i>
                    </div>
                    <div class="locutor-para">
                      <label>Para:</label>
                      <span class="nome-para">{{ formatarNomeParticipante(novoLocutor) }}</span>
                    </div>
                  </div>
                
                  <!-- Lista de locutores existentes -->
                  <div class="sugestoes" *ngIf="participantesUnicos.length > 1">
                    <label>
                      <i class="fas fa-users"></i>
                    </label>
                    <div class="lista-sugestoes">
                      <button 
                        class="btn-sugestao"
                        *ngFor="let participante of participantesUnicos"
                        [disabled]="participante.nome === locutorOriginal"
                        [class.selecionado]="participante.nome === novoLocutor"
                        [class.novo-locutor]="isNovoLocutor(participante.nome)"
                        (click)="selecionarSugestao(participante.nome)">
                        <span class="nome">{{ participante.nome }}</span>
                        <small>{{ participante.tipo }}</small>
                        <i class="fas fa-check" *ngIf="participante.nome === novoLocutor"></i>
                        <span class="badge-novo" *ngIf="isNovoLocutor(participante.nome)">NOVO</span>
                      </button>
                    </div>
                  </div>
                  
                  <!-- Bot√£o para adicionar novo locutor -->
                  <div class="acao-adicionar">
                    <button class="btn-adicionar-locutor" (click)="ativarModoAdicionarNovoLocutor()">
                      <i class="fas fa-plus"></i>
                      Criar novo locutor
                    </button>
                  </div>
                  
                  <!-- Confirma√ß√£o de sele√ß√£o -->
                  <div class="confirmacao-selecao" *ngIf="novoLocutor.trim()">
                    <div class="selecao-info">
                      <i class="fas fa-check-circle"></i>
                      <span>Locutor selecionado: <strong>{{ formatarNomeParticipante(novoLocutor) }}</strong></span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Popup para novo locutor -->
              <div class="popup-overlay" *ngIf="showPopupNovoLocutor" (click)="cancelarNovoLocutor()">
                <div class="popup-novo-locutor" (click)="$event.stopPropagation()">
                  <div class="popup-header">
                    <h4>
                      <i class="fas fa-user-plus"></i>
                      Adicionar Novo Locutor
                    </h4>
                    <button class="btn-fechar-popup" (click)="cancelarNovoLocutor()">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
                
                <!-- SE√á√ÉO 1: EDITAR LOCUTOR ATUAL -->
                <div class="secao-editar-locutor">
                  <h4 class="titulo-secao">
                    <i class="fas fa-user-edit"></i>
                    1. Editar Locutor Atual
                  </h4>
                  <p class="descricao-secao">Alterar nome e papel deste locutor em toda a transcri√ß√£o</p>
                  
                  <div class="locutor-atual-info">
                    <div class="locutor-dados">
                      <span class="nome-atual">{{ formatarNomeParticipante(locutorOriginal) }}</span>
                    </div>
                    <button class="btn-editar-locutor" 
                            (click)="iniciarEdicaoLocutorAtual()" 
                            title="Editar nome e papel deste locutor">
                      <i class="fas fa-user-edit"></i>
                      Editar
                    </button>
                  </div>

                  <!-- Interface de edi√ß√£o do locutor atual -->
                  <div class="edicao-locutor-atual" *ngIf="editandoLocutorAtual">
                    <div class="campo-edicao">
                      <label>
                        <i class="fas fa-user"></i>
                        Nome completo:
                      </label>
                      <input 
                        type="text" 
                        [(ngModel)]="locutorAtualNomeEdicao"
                        placeholder="Nome do locutor"
                        class="input-edicao">
                    </div>
                    
                    <div class="campo-edicao">
                      <label>
                        <i class="fas fa-briefcase"></i>
                        Papel/Fun√ß√£o:
                      </label>
                      
                      <!-- Nuvem de Tags -->
                      <div class="nuvem-tags">
                        <div class="tag-opcao" 
                             [class.selecionada]="locutorAtualPapelEdicao === 'Testemunha'"
                             (click)="selecionarPapelLocutorAtual('Testemunha')">
                          <i class="fas fa-user-tie"></i>
                          Testemunha
                        </div>
                        <div class="tag-opcao" 
                             [class.selecionada]="locutorAtualPapelEdicao === 'Advogado'"
                             (click)="selecionarPapelLocutorAtual('Advogado')">
                          <i class="fas fa-balance-scale"></i>
                          Advogado
                        </div>
                        <div class="tag-opcao" 
                             [class.selecionada]="locutorAtualPapelEdicao === 'Perito'"
                             (click)="selecionarPapelLocutorAtual('Perito')">
                          <i class="fas fa-microscope"></i>
                          Perito
                        </div>
                      </div>
                      
                      <input 
                        type="text" 
                        [(ngModel)]="locutorAtualPapelEdicao"
                        placeholder="Ou digite um papel customizado..."
                        class="input-edicao input-customizado">
                    </div>
                    
                    <div class="acoes-edicao">
                      <button class="btn-cancelar-edicao" (click)="cancelarEdicaoLocutorAtual()">
                        <i class="fas fa-times"></i>
                        Cancelar
                      </button>
                      <button 
                        class="btn-salvar-edicao" 
                        [disabled]="!locutorAtualNomeEdicao.trim() || !locutorAtualPapelEdicao.trim()"
                        (click)="salvarEdicaoLocutorAtual()">
                        <i class="fas fa-check"></i>
                        Salvar Altera√ß√µes
                      </button>
                    </div>
                  </div>
                </div>

                <!-- DIVISOR -->
                <div class="divisor">
                  <span>OU</span>
                </div>

                <!-- SE√á√ÉO 2: TROCAR LOCUTOR DA FRASE -->
                <div class="secao-trocar-locutor" *ngIf="!editandoLocutorAtual">
                  <h4 class="titulo-secao">
                    <i class="fas fa-user-edit"></i>
                    Selecionar Locutor
                  </h4>
                  <p class="descricao-secao">Alterar apenas quem fala nesta frase espec√≠fica</p>
                  
                  <div class="info-alteracao" *ngIf="novoLocutor.trim()">
                    <div class="locutor-de">
                      <label>De:</label>
                      <span class="nome-de">{{ formatarNomeParticipante(locutorOriginal) }}</span>
                    </div>
                    <div class="seta-alteracao">
                      <i class="fas fa-arrow-right"></i>
                    </div>
                    <div class="locutor-para">
                      <label>Para:</label>
                      <span class="nome-para">{{ formatarNomeParticipante(novoLocutor) }}</span>
                    </div>
                  </div>
                
                  <!-- Lista de locutores existentes -->
                  <div class="sugestoes" *ngIf="participantesUnicos.length > 1">
                    <label>
                      <i class="fas fa-users"></i>
                    </label>
                    <div class="lista-sugestoes">
                      <button 
                        class="btn-sugestao"
                        *ngFor="let participante of participantesUnicos"
                        [disabled]="participante.nome === locutorOriginal"
                        [class.selecionado]="participante.nome === novoLocutor"
                        [class.novo-locutor]="isNovoLocutor(participante.nome)"
                        (click)="selecionarSugestao(participante.nome)">
                        <span class="nome">{{ participante.nome }}</span>
                        <small>{{ participante.tipo }}</small>
                        <i class="fas fa-check" *ngIf="participante.nome === novoLocutor"></i>
                        <span class="badge-novo" *ngIf="isNovoLocutor(participante.nome)">NOVO</span>
                      </button>
                    </div>
                  </div>
                  
                  <!-- Bot√£o para adicionar novo locutor -->
                  <div class="acao-adicionar">
                    <button class="btn-adicionar-locutor" (click)="ativarModoAdicionarNovoLocutor()">
                      <i class="fas fa-plus"></i>
                      Criar novo locutor
                    </button>
                  </div>
                  
                  <!-- Confirma√ß√£o de sele√ß√£o -->
                  <div class="confirmacao-selecao" *ngIf="novoLocutor.trim()">
                    <div class="selecao-info">
                      <i class="fas fa-check-circle"></i>
                      <span>Locutor selecionado: <strong>{{ formatarNomeParticipante(novoLocutor) }}</strong></span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Popup para novo locutor -->
              <div class="popup-overlay" *ngIf="showPopupNovoLocutor" (click)="cancelarNovoLocutor()">
                <div class="popup-novo-locutor" (click)="$event.stopPropagation()">
                  <div class="popup-header">
                    <h4>
                      <i class="fas fa-user-plus"></i>
                      Adicionar Novo Locutor
                    </h4>
                    <button class="btn-fechar-popup" (click)="cancelarNovoLocutor()">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                  
                  <div class="popup-body">
                    <div class="campo-popup">
                      <label for="inputNomeLocutor">
                        <i class="fas fa-user"></i>
                        Nome completo:
                      </label>
                      <input 
                        id="inputNomeLocutor"
                        type="text" 
                        [(ngModel)]="novoLocutorNome"
                        placeholder="Ex: Dr. Jo√£o Silva Santos"
                        class="input-popup">
                    </div>
                    
                    <div class="campo-popup">
                      <label>
                        <i class="fas fa-briefcase"></i>
                        Papel/Fun√ß√£o:
                      </label>
                      
                      <!-- Nuvem de Tags -->
                      <div class="nuvem-tags">
                        <div class="tag-opcao" 
                             [class.selecionada]="novoLocutorPapel === 'Testemunha'"
                             (click)="selecionarPapel('Testemunha')">
                          <i class="fas fa-user-tie"></i>
                          Testemunha
                        </div>
                        <div class="tag-opcao" 
                             [class.selecionada]="novoLocutorPapel === 'Advogado'"
                             (click)="selecionarPapel('Advogado')">
                          <i class="fas fa-balance-scale"></i>
                          Advogado
                        </div>
                        <div class="tag-opcao" 
                             [class.selecionada]="novoLocutorPapel === 'Perito'"
                             (click)="selecionarPapel('Perito')">
                          <i class="fas fa-microscope"></i>
                          Perito
                        </div>
                      </div>
                      
                      <!-- Campo customizado (opcional) -->
                      <input 
                        id="inputPapelLocutor"
                        type="text" 
                        [(ngModel)]="novoLocutorPapel"
                        placeholder="Ou digite um papel customizado..."
                        class="input-popup input-customizado">
                    </div>
                  </div>
                  
                  <div class="popup-footer">
                    <button class="btn-cancelar-popup" (click)="cancelarNovoLocutor()">
                      <i class="fas fa-times"></i>
                      Cancelar
                    </button>
                    <button 
                      class="btn-salvar-popup" 
                      [disabled]="!novoLocutorNome.trim() || !novoLocutorPapel.trim()"
                      (click)="salvarNovoLocutor()">
                      <i class="fas fa-check"></i>
                      Adicionar
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="modal-footer-locutor">
                <button class="btn-cancelar" (click)="cancelarEdicaoLocutor()">
                  <i class="fas fa-times"></i>
                  Cancelar
                </button>
                <button 
                  class="btn-confirmar" 
                  [disabled]="!novoLocutor.trim() || (novoLocutor.trim() === locutorOriginal && !locutorAtualFoiEditado)"
                  (click)="confirmarEdicaoLocutor()">
                  <i class="fas fa-check"></i>
                  Confirmar Altera√ß√£o
                </button>
              </div>
            </div>
          </div>

          <!-- Popup Editar Locutor -->
          <div class="popup-overlay" *ngIf="popupEditarLocutorVisivel">
            <div class="popup-editar-locutor">
              <div class="popup-header">
                <h3>Editar Locutor</h3>
                <button class="btn-fechar-popup" (click)="cancelarEdicaoLocutorPopup()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              
              <div class="popup-content">
                <div class="input-group">
                  <label for="inputNomeLocutorEdicao">Nome do Locutor:</label>
                  <input 
                    id="inputNomeLocutorEdicao"
                    type="text" 
                    [(ngModel)]="locutorEdicaoNome"
                    placeholder="Digite o nome do locutor..."
                    class="input-popup">
                </div>
                
                <div class="input-group">
                  <label for="inputPapelLocutorEdicao">Papel do Locutor:</label>
                  <div class="papel-container">
                    <!-- Pap√©is predefinidos -->
                    <div class="papel-buttons">
                      <button 
                        *ngFor="let papel of papeisPredefinidos"
                        class="btn-papel"
                        [class.ativo]="locutorEdicaoPapel === papel"
                        (click)="selecionarPapelEdicao(papel)">
                        {{ papel }}
                      </button>
                    </div>
                    
                    <!-- Campo customizado (opcional) -->
                    <input 
                      id="inputPapelLocutorEdicao"
                      type="text" 
                      [(ngModel)]="locutorEdicaoPapel"
                      placeholder="Ou digite um papel customizado..."
                      class="input-popup input-customizado">
                  </div>
                </div>
              </div>
              
              <div class="popup-footer">
                <button class="btn-cancelar-popup" (click)="cancelarEdicaoLocutorPopup()">
                  <i class="fas fa-times"></i>
                  Cancelar
                </button>
                <button 
                  class="btn-salvar-popup" 
                  [disabled]="!locutorEdicaoNome.trim() || !locutorEdicaoPapel.trim()"
                  (click)="salvarEdicaoLocutor()">
                  <i class="fas fa-check"></i>
                  Salvar
                </button>
              </div>
            </div>
          </div>

          <!-- Participantes (modo normal) -->
          <div class="secao-participantes" *ngIf="!modoEdicaoLocutor">
            <h3>Participantes</h3>
            <div class="lista-participantes">
              <div class="participante-item" 
                   *ngFor="let participante of participantesUnicos">
                <span class="participante-nome">{{ participante.nome }}</span>
                <span class="participante-tipo">{{ participante.tipo }}</span>
              </div>
            </div>
          </div>

          <!-- Hist√≥rico de Altera√ß√µes (sempre vis√≠vel) -->
          <div class="secao-historico" *ngIf="!modoEdicaoLocutor">
            <h3>Hist√≥rico</h3>
            <div class="lista-historico">
              <div class="historico-item" 
                   *ngFor="let item of getHistoricoGeral().slice(0, 10)">
                <div class="historico-data">{{ item.data | date:'dd/MM HH:mm' }}</div>
                <div class="historico-usuario">{{ item.usuario }}</div>
                <div class="historico-tipo">{{ item.tipo }}</div>
              </div>
            </div>
          </div>

          <!-- Estat√≠sticas -->
          <div class="secao-estatisticas" *ngIf="!modoEdicaoLocutor">
            <h3>Estat√≠sticas</h3>
            <div class="estatistica-item">
              <span class="estatistica-label">Total de di√°logos:</span>
              <span class="estatistica-valor">{{ dialogos.length }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer do Modal -->
    <div class="modal-footer">
      <button class="btn btn-secundario" (click)="fecharModal()">Cancelar</button>
      <button class="btn btn-primario" (click)="salvarTranscricao()">Salvar Altera√ß√µes</button>
    </div>
  </div>
</div>

<!-- Modal de V√≠deo -->
<div class="modal-overlay-video" *ngIf="modalVideoAberto" (click)="fecharModalVideo()">
  <div class="modal-video" (click)="$event.stopPropagation()">
    <div class="modal-video-header">
      <h3>
        <i class="fas fa-video"></i>
        V√≠deo - {{ dialogoVideoModal?.participante }} - {{ dialogoVideoModal?.timestamp }}
      </h3>
      <button class="btn-fechar-video" (click)="fecharModalVideo()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-video-content">
      <div class="video-info-modal">
        <div class="info-dialogo">
          <span class="timestamp-modal">‚è∞ {{ dialogoVideoModal?.timestamp }}</span>
          <span class="participante-modal">üë§ {{ formatarNomeParticipante(dialogoVideoModal?.participante) }}</span>
        </div>
        <div class="texto-fala-modal">
          {{ dialogoVideoModal?.texto }}
        </div>
      </div>
      
      <div class="video-player-modal">
        <video #videoPlayerModal 
               controls 
               autoplay
               class="video-elemento">
          <source src="assets/video.mp4" type="video/mp4">
          Seu navegador n√£o suporta o elemento de v√≠deo.
        </video>
      </div>
    </div>
  </div>
</div>
